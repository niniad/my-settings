---
name: factory-chatlog
description: "1688工場チャットログの解析・NocoDB登録スキル。ユーザーが1688.comの工場とのチャットテキストやスクリーンショットを共有したら、Q&Aを抽出してNocoDBの工場チャットログテーブルに反映する。トリガー: (1) 工場チャットのテキスト貼り付け、(2) チャット画面のスクリーンショット共有、(3)「チャットログ登録」「工場チャット記録」「やり取りを記録」等の依頼、(4) 工場との問い合わせ内容の管理。商品カテゴリを問わず汎用的に使用。"
---

# 工場チャットログ登録スキル

## NocoDB アクセス

**nocodb スキル（`~/.claude/skills/nocodb/SKILL.md`）を参照。** API接続情報・CRUD操作の詳細はそちらに記載。

### Windows環境の必須事項

- **curl で CJK 文字を含む JSON を送信しない。** Python（urllib）経由で API を呼ぶ。
- トークンは事前に bash で取得し環境変数で渡す:
  ```
  export NOCODB_TOKEN=$(gcloud secrets versions access latest --secret=NOCODB_API_TOKEN --project=main-project-477501 | tr -d '\r\n')
  uv run python tmp/insert_chatlog_xxx.py
  ```
- Python スクリプト内の CJK 文字はすべて `\uXXXX` エスケープで記述する。
- `json.dumps(data, ensure_ascii=False).encode('utf-8')` でエンコードし `urllib.request` で送信。

## 対象テーブル（商品カテゴリ別）

商品カテゴリごとに NocoDB の BASE が分かれている。**対象が不明なら確認する。** 会話の文脈から明らかなら確認不要。

| 商品カテゴリ | Base ID | チャットログ Table ID | 工場 Table ID | 商品 Table ID |
|------------|---------|---------------------|--------------|--------------|
| スタイ | `po7e20ukkkvx4lm` | `mmpb7slkrrapt27` | `mr164uloznd64ob` | `mg5j7bp96bsmb3l` |

新しい BASE 追加時はこの表に追記する。

### カラム構成（全 BASE 共通）

| カラム名 | 型 | 説明 |
|---------|------|------|
| 問い合わせカテゴリ | MultiSelect | 価格, カスタマイズ, MOQ, 納期, サンプル, その他 |
| 問い合わせ事項 | SingleLineText | 日本語要約（30文字以内） |
| 質問原文 | LongText | ユーザー送信の中国語原文 |
| 質問日本語訳 | LongText | 質問原文の日本語直訳 |
| 回答原文（中国語） | LongText | 工場の中国語回答（未回答なら空欄） |
| 回答日本語訳 | LongText | 回答の日本語訳（未回答なら空欄） |
| 日時 | DateTime | ISO 8601（`2026-01-16T11:23:33`） |
| 回答ステータス | SingleSelect | 回答待ち / 回答済み / 一部回答 |
| 備考 | LongText | 補足情報 |
| 工場 | LinkToAnotherRecord (bt) | 工場テーブルへのリレーション |
| 対象商品 | LinkToAnotherRecord (mm) | 商品テーブルへの多対多リレーション |

## 入力形式

| 形式 | 処理 |
|------|------|
| テキスト貼り付け | メッセージの送信者・日時・内容を抽出 |
| スクリーンショット | Read ツールで画像を読み取り解析 |
| ファイルパス指定 | Read ツールでファイルを読み取り |

### スクリーンショットの読み取り

1688.com チャット画面のレイアウト:
- **左側 = 工場、右側 = ユーザー**
- アカウント名とタイムスタンプ（`YYYY-MM-DD HH:MM:SS`）を読み取る
- 商品カード（画像+商品名+価格）はプロモーションの可能性 → 除外ルールで判定
- 不鮮明な部分はユーザーに確認

## チャット解析ルール

### 記録対象

**ユーザーが送信した質問** を中心に記録する。

- Q&A ペア → 1行（質問+回答）
- 未回答の質問 → 1行（回答ステータス=「回答待ち」）
- 1メッセージに複数質問 → 質問ごとに行を分ける（同一タイムスタンプ）
- 工場が複数回に分けて回答 → 回答を結合して1行

### 回答ステータス

| ステータス | 条件 |
|-----------|------|
| 回答済み | 質問に明確に回答 |
| 回答待ち | 工場からの回答がない |
| 一部回答 | 一部のみ回答、趣旨とずれた回答、断片的・曖昧な回答（備考に詳細記載） |

### 除外対象（記録しない）

- **工場の自動メッセージ**: 新商品紹介、商品カード（画像+価格 `¥XX.XX`）、「热销款」「新款」等のPR → 判定基準: ユーザーの質問が先行していない工場発メッセージ
- **挨拶・定型文**: 「你好」「欢迎光临」、自動応答
- **商品リンクのみ**: 質疑が発生していないリンク共有

### 微妙なケース

- 工場PR後にユーザーが質問 → **Q&Aペアのみ記録**（PR部分は除外）
- 工場が質問を無視して別話題 → **質問を「回答待ち」で記録**

## 処理フロー

1. **BASE 確認**: 対象が不明なら確認
2. **チャット解析**: メッセージ抽出 → 除外ルール適用
3. **工場特定**: アカウント名から工場テーブルのIDを取得（新規工場はユーザーに確認）
4. **Q&A 構造化**: カテゴリ・事項・質問原文・質問日本語訳（直訳）・回答原文・回答日本語訳・ステータスを整理
5. **ユーザー確認**: 登録内容を一覧提示（除外理由も明示）
6. **重複チェック**: 同一工場・同一日時のレコードが既存なら通知。「回答待ち」への回答は更新
7. **NocoDB 登録**: Python スクリプト（`tmp/insert_chatlog_xxx.py`）で実行

## カテゴリ選択ガイド（MultiSelect）

複数該当する場合はすべて選択。

| カテゴリ | 対象 |
|---------|------|
| 価格 | 単価・値引き・版代・型代などコスト全般 |
| カスタマイズ | OEM・ODM・タグ変更・デザイン変更・素材変更 |
| MOQ | 最小注文数量・ロット数 |
| 納期 | 生産期間・出荷時期・リードタイム |
| サンプル | サンプル注文・確認・費用 |
| その他 | 上記に該当しないもの |

例：「OEMでのMOQと版代は？」→ カスタマイズ, MOQ, 価格

## 問い合わせ事項の書き方

自然な日本語で簡潔に（30文字以内）。中国語混じりは避ける。

- 防水款 → 防水タイプ、現貨 → 在庫品、換標 → タグ変更
- 良い例：「在庫品のタグ変更対応」「OEM製作のMOQ・版代」
- 悪い例：「現貨の換標対応」「防水款(9.8元) 換標対応」
